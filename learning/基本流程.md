# 信令与视频通话
- WebRTC允许在两个设备之间进行实时的对等媒体交换。
- 通过称为**Signaling**的发现和协商过程建立连接。
- 两个设备连接到第三个共同商定的服务器。通过这个第三方服务器，这两台设备可以相互定位，并交换协商消息
## 信令服务器
- 两个设备之间建立 WebRTC 连接需要一个信令服务器来实现双方通过网络进行连接。
- 使用WebSocket方式来交换彼此的信令信息
- **信令服务器不需要理解信令数据内容**（基于SDP），ICE子系统指示你将信令数据发送给另一个对等方时，你就这样做，而另一个对等方知道如何接收此信息并将其传递给自己的 ICE 子系统。你所要做的就是来回传递信息。内容对信令服务器一点都不重要。
### 信令服务器的Websocket实现
- 构建一套信息交换规则，我们需要一套协议来定义消息格式。
- 字符串化的 JSON 对象来和客户端通信
### 交换会话描述信息
- 用户的初始化操作会创建一个请求（offer）
- 根据SDP协议，其中会包含一个session描述，并且需要把这个发送到接收者callee
- 接收者返回一个包含描述符的应答（answer）
- "video-offer"与"video-answer"
  - type：消息类型 "video-offer" 或 "video-answer"
  - name：发送者用户名
  - target：接收者用户名
  - sdp：描述连接本地端 SDP（Session Description Protocol）协议字符串（从接收者的角度来看，它描述远程端）
- 到此为止双方都知道使用什么样的代码和参数进行通信了，接下来由ICE提供服务
### 交换ICE候选
- 两个节点需要交换 ICE 候选来协商他们自己具体如何连接。每一个 ICE 候选描述**一个发送者使用的通信方法**，每个节点按照他们被发现的顺序发送候选并且保持发送直到退出，即使媒体数据流已经开始传递也要如此。
- 一旦两端同意了一个互相兼容的候选，该候选的 SDP 就被用来创建并打开一个连接，通过该连接媒体流就开始运转。如果之后他们同意了一个更好（通常更高效）的候选，流亦会按需变更格式。
- 每个 ICE 候选通过**信令服务器**发送一个 "new-ice-candidate" 类型的 JSON 信息来送给远程的另一端。每个候选信息包括以下字段：
  - type："new-ice-candidate"
  - target：待建立联系人的用户名，服务器将仅会管理与该用户的信息。
  - candidate：SDP 候选字符串，描述了**计划的连接方法**。通常不需要查看此字符串的内容。你需要做的所有代码都是使用信令服务器将其路由到远程对等机。
- 每个 ICE 消息都建议提供一个**通信协议（TCP 或 UDP）、IP 地址、端口号、连接类型**（例如，指**定的 IP 是对等机本身还是中继服务器**），以及将两台计算机连接在一起所需的其他信息。这包括 **NAT 或其他网络问题**。

**理解**：SDP由WebRTC模块中的API创建，其中包含了{媒体信息}{网络连接信息}，交换**会话描述信息**时，确认彼此的媒体流信息，而交换**ICE candidate**时确认peer connection方式（怎么建立peer connection，stun/turn）。

![webrtc_-_signaling_diagram](F:\博士期间\Learning\WebRTC\webrtc_-_signaling_diagram.svg)

![webrtc_-_ice_candidate_exchange](F:\博士期间\Learning\WebRTC\webrtc_-_ice_candidate_exchange.svg)

